{% extends "layout.html" %}
{% block title %}Teacher Dashboard{% endblock %}
{% block content %}
  <h2 style="color:var(--primary);">Teacher Dashboard</h2>
  <div class="stats-cards">
    <div class="stats-card">
      <h2>{{ total_students }}</h2>
      <span>Students</span>
    </div>
    <div class="stats-card">
      <h2>{{ total_tests }}</h2>
      <span>Tests</span>
    </div>
    <div class="stats-card">
      <h2>{{ avg_percentage }}%</h2>
      <span>Avg. Percentage</span>
    </div>
  </div>

  <button id="showGraphBtn" style="background:var(--secondary);color:#fff;padding:0.7em 1.2em;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-bottom:1em;">Show Graph</button>

  <!-- Modal -->
  <div id="graphModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2em;border-radius:18px;max-width:400px;width:90%;margin:auto;position:relative;">
      <span id="closeModal" style="position:absolute;top:10px;right:18px;cursor:pointer;font-size:1.5em;">&times;</span>
      <h3>Student Progress Graph</h3>
      <form id="graphForm">
        <label for="studentSelect">Student</label>
        <select id="studentSelect" name="student" required>
          {% for s in students %}
            <option value="{{ s['name'] }}">{{ s['name'] }} ({{ s['class'] }})</option>
          {% endfor %}
        </select>
        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" name="start_date" required>
        <label for="endDate">End Date</label>
        <input type="date" id="endDate" name="end_date" required>
        <button type="submit" style="margin-top:1em;">Show</button>
      </form>
      <canvas id="progressChart" style="margin-top:1em;max-width:100%;"></canvas>
    </div>
  </div>

  <h3>Add Student</h3>
  <form method="post" action="{{ url_for('add_student') }}">
    <label for="name">Name</label>
    <input type="text" name="name" required>
    <label for="password">Password</label>
    <input type="password" name="password" required>
    <label for="class">Class</label>
    <input type="text" name="class" required>
    <label for="phone1">Phone 1</label>
    <input type="text" name="phone1" required>
    <label for="phone2">Phone 2</label>
    <input type="text" name="phone2">
    <label for="phone3">Phone 3</label>
    <input type="text" name="phone3">
    <button type="submit">Add Student</button>
  </form>

  <h3>Add Test</h3>
  <form method="post" action="{{ url_for('add_test') }}">
    <label for="student">Student</label>
    <select name="student" required>
      {% for s in students %}
        <option value="{{ s['name'] }}">{{ s['name'] }} ({{ s['class'] }})</option>
      {% endfor %}
    </select>
    <label for="class">Class</label>
    <input type="text" name="class" required>
    <label for="subject">Subject</label>
    <input type="text" name="subject" required>
    <label for="test_no">Test No.</label>
    <input type="text" name="test_no" required>
    <label for="marks">Marks</label>
    <input type="number" name="marks" required>
    <label for="total_marks">Total Marks</label>
    <input type="number" name="total_marks" required>
    <label for="date">Date</label>
    <input type="date" name="date">
    <button type="submit">Add Test</button>
  </form>

  <h3>All Tests</h3>
  <table class="table-gradient">
    <tr>
      <th>Student</th><th>Class</th><th>Subject</th><th>Test No.</th><th>Marks</th><th>Total</th><th>%</th><th>Date</th>
    </tr>
    {% for t in tests %}
      <tr>
        <td>{{ t['student'] }}</td>
        <td>{{ t['class'] }}</td>
        <td>{{ t['subject'] }}</td>
        <td>{{ t['test_no'] }}</td>
        <td>{{ t['marks'] }}</td>
        <td>{{ t['total_marks'] }}</td>
        <td>
          {% if t['total_marks']|float > 0 %}
            {{ ((t['marks']|float / t['total_marks']|float) * 100)|round(2) }}%
          {% else %}0{% endif %}
        </td>
        <td>{{ t['date'] }}</td>
      </tr>
    {% endfor %}
  </table>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}